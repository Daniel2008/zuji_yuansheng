# 足迹动态接口使用文档

## 接口概述

本文档描述了足迹动态列表接口的对接实现，该接口用于获取用户发布的足迹动态信息。

## 接口信息

- **接口地址**: `http://192.168.1.5:8080/zuji/api/getMsgList`
- **请求方法**: POST
- **认证方式**: Bearer Token

## 请求参数

### Header参数
```
Authorization: Bearer {token}
Content-Type: application/json
```

### Body参数
```json
{
    "pageNum": 1,
    "pageSize": 10
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| pageNum | int | 是 | 页码，从1开始 |
| pageSize | int | 是 | 每页记录数，建议1-100 |

## 响应数据

### 成功响应
```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "records": [
            {
                "createBy": "沉默的查理",
                "createTime": "2025-01-03 00:57:33",
                "updateBy": "",
                "updateTime": "2025-01-03 00:57:33",
                "remark": null,
                "id": 108,
                "msgType": 1,
                "textContent": "今夜无眠，1月2日地震两次，从银川到镇北堡，完全不敢睡",
                "tag": "随想",
                "lng": 106.068,
                "lat": 38.6238,
                "localtionTitle": "位置为：经度106.0676，纬度38.6238",
                "userId": 102,
                "userAvatar": "/profile/upload/2024/12/05/tmp_98a509bc19013df39071ce5878a8d0683739f64557f8631e_20241205060716A001.jpg",
                "delFlag": "0",
                "guluFiles": [
                    {
                        "createBy": "沉默的查理",
                        "createTime": "2025-01-03 00:57:33",
                        "updateBy": "",
                        "updateTime": "2025-01-03 00:57:33",
                        "remark": null,
                        "id": 130,
                        "fileName": "/profile/upload/2025/01/02/tmp_a8df734f94c6c515491ecaa4590a50e203f3322ee0cefa72_20250102165557A001",
                        "fileType": "jpg",
                        "filePath": "/profile/upload/2025/01/02/tmp_a8df734f94c6c515491ecaa4590a50e203f3322ee0cefa72_20250102165557A001.jpg",
                        "ofType": "1",
                        "ofId": 108,
                        "delFlag": "0"
                    }
                ]
            }
        ],
        "total": 1,
        "current": 1,
        "size": 10,
        "pages": 1
    }
}
```

### 响应字段说明

#### 基础响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | int | 响应状态码，200表示成功 |
| msg | string | 响应消息 |
| data | object | 响应数据 |

#### 分页数据字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| records | array | 足迹动态记录列表 |
| total | int | 总记录数 |
| current | int | 当前页码 |
| size | int | 每页大小 |
| pages | int | 总页数 |

#### 足迹动态记录字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 动态ID |
| createBy | string | 创建者 |
| createTime | string | 创建时间 |
| msgType | int | 消息类型 |
| textContent | string | 文本内容 |
| tag | string | 标签 |
| lng | double | 经度 |
| lat | double | 纬度 |
| localtionTitle | string | 位置标题 |
| userId | int | 用户ID |
| userAvatar | string | 用户头像路径 |
| guluFiles | array | 关联文件列表 |

#### 文件信息字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 文件ID |
| fileName | string | 文件名 |
| fileType | string | 文件类型 |
| filePath | string | 文件路径 |
| ofType | string | 关联类型 |
| ofId | int | 关联ID |

## 代码实现

### 1. API服务调用

在 `HutoolApiService.java` 中已经实现了 `getFootprintMessages` 方法：

```java
public void getFootprintMessages(int pageNum, int pageSize,
                                  Response.Listener<FootprintMessageResponse.Data> successListener,
                                  Response.ErrorListener errorListener)
```

### 2. 在MapFragment中使用

```java
// 初始化API服务
apiService = HutoolApiService.getInstance(requireContext());

// 调用接口
apiService.getFootprintMessages(
    1, // 页码
    10, // 每页大小
    new Response.Listener<FootprintMessageResponse.Data>() {
        @Override
        public void onResponse(FootprintMessageResponse.Data response) {
            // 处理成功响应
            handleFootprintMessages(response.getRecords());
        }
    },
    new Response.ErrorListener() {
        @Override
        public void onErrorResponse(VolleyError error) {
            // 处理错误响应
            Log.e(TAG, "获取足迹动态列表失败: " + error.getMessage());
        }
    }
);
```

### 3. 数据模型

项目中已经定义了相应的数据模型：
- `FootprintMessageResponse.java` - 响应数据模型
- `FootprintMessage.java` - 足迹动态实体
- `GuluFile.java` - 文件实体

## 功能特性

### 1. 网络状态监控
- 自动检测网络状态
- 网络断开时将请求加入待处理队列
- 网络恢复时自动重试失败的请求

### 2. 认证处理
- 自动添加Bearer Token到请求头
- 支持用户登录状态检查

### 3. 错误处理
- 网络错误自动重试
- 详细的错误日志记录
- 用户友好的错误提示

### 4. 地图集成
- 在地图上显示足迹动态位置标记
- 支持点击查看动态详情
- 区分普通足迹和动态足迹的图标

## 使用示例

### 基本调用
```java
// 获取第一页数据
loadFootprintMessages();

// 刷新数据
refreshFootprintMessages();
```

### 分页加载
```java
// 加载更多数据
apiService.getFootprintMessages(
    currentPage + 1, 
    pageSize, 
    successListener, 
    errorListener
);
```

## 注意事项

1. **认证要求**: 调用接口前确保用户已登录并获取有效token
2. **网络权限**: 确保应用已获取网络访问权限
3. **错误处理**: 建议实现完善的错误处理机制
4. **性能优化**: 避免频繁调用接口，建议实现缓存机制
5. **图标资源**: 需要准备 `ic_message_marker` 图标资源文件

## 测试

项目中包含了单元测试文件 `FootprintMessageApiTest.java`，可以用于验证接口功能。

## 更新日志

- 2025-01-03: 完成足迹动态接口对接
- 添加了网络状态监控功能
- 实现了地图标记显示功能
- 添加了完整的错误处理机制